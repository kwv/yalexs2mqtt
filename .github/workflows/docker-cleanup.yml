name: Docker Hub Cleanup

on:
  schedule:
    - cron: "0 4 * * 0"  # every Sunday at 04:00 UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry Run (true/false)'
        required: true
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      NAMESPACE: kwv4
      REPO: yalexs2mqtt
      KEEP_RECENT: '2'
      OLDER_THAN_DAYS: '15'
      PROTECTED_REGEX: '^(latest|stable|dev)$'
      DRY_RUN: ${{ inputs.dry_run || 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git tags

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Cleanup Docker and Git Tags
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -e
          
          echo "üöÄ Starting synchronized cleanup for $NAMESPACE/$REPO"
          echo "üîπ KEEP_RECENT: $KEEP_RECENT"
          echo "üîπ DRY_RUN: $DRY_RUN"
          
          # 1. Authenticate with Docker Hub
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "'${DOCKER_USERNAME}'", "password": "'${DOCKER_PASSWORD}'"}' https://hub.docker.com/v2/users/login/ | jq -r .token)
          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then echo "::error::Failed to authenticate"; exit 1; fi

          # 2. Get Version Info from Git (Primary Source for releases)
          echo "üìä Analyzing Git tags..."
          # Fetch all tags and filter for semantic versioning (vX.Y.Z)
          # Note: uses git tag sort to handle version hierarchy correctly
          GIT_VERSION_TAGS=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          VERSION_TAGS_TO_KEEP=$(echo "$GIT_VERSION_TAGS" | head -n "$KEEP_RECENT")
          
          # 3. Get Version Info from Docker Hub
          echo "üìä Analyzing Docker Hub tags..."
          TAGS_JSON=$(curl -s -H "Authorization: JWT $TOKEN" "https://hub.docker.com/v2/repositories/$NAMESPACE/$REPO/tags/?page_size=100")
          DOCKER_TAGS=$(echo "$TAGS_JSON" | jq -r '.results[].name')
          
          # 4. Consolidate list of all unique version tags (v*) from both systems
          ALL_VERSION_TAGS=$(printf "%s\n%s" "$(echo "$GIT_VERSION_TAGS")" "$(echo "$DOCKER_TAGS")" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -u || true)

          echo "--------------------------------------------------------------------------------"
          printf "%-25s %-10s %-20s\n" "TAG" "STATUS" "PLAN"
          echo "--------------------------------------------------------------------------------"

          for tag in $ALL_VERSION_TAGS; do
            ACTION="DELETE"
            REASON="Old version"
            
            # Check if we should keep it
            if echo "$VERSION_TAGS_TO_KEEP" | grep -qX "$tag"; then
              ACTION="KEEP"
              REASON="Recent release"
            fi
            
            # Check if it matches 'latest' or other protected tags (sanity check, though v* usually doesn't)
            if [[ "$tag" =~ $PROTECTED_REGEX ]]; then
              ACTION="KEEP"
              REASON="Protected"
            fi

            printf "%-25s %-10s %-20s\n" "$tag" "$ACTION" "$REASON"

            if [ "$ACTION" == "DELETE" ]; then
              if [ "$DRY_RUN" == "true" ]; then
                echo "   [DRY RUN] Would delete $tag from Docker Hub and Git"
              else
                # Delete from Docker Hub
                if echo "$DOCKER_TAGS" | grep -qX "$tag"; then
                  echo "   üóëÔ∏è Deleting Docker tag: $tag"
                  curl -s -X DELETE -H "Authorization: JWT $TOKEN" "https://hub.docker.com/v2/repositories/$NAMESPACE/$REPO/tags/$tag/" > /dev/null
                fi
                # Delete from Git
                if git rev-parse "$tag" >/dev/null 2>&1; then
                  echo "   üóëÔ∏è Deleting Git tag: $tag"
                  git tag -d "$tag" > /dev/null
                  git push origin --delete "$tag" > /dev/null || echo "   ‚ö†Ô∏è Git push delete failed (tag might be gone)"
                fi
              fi
            fi
          done
          echo "--------------------------------------------------------------------------------"
          echo "‚úÖ Cleanup plan complete."
